---
import { getLocaleUrlCTM, supportedLanguages } from "@/lib/utils/i18nUtils";
import trailingSlashChecker from "@/lib/utils/trailingSlashChecker";

const currentLocale = Astro.currentLocale;
const currentPath = trailingSlashChecker(Astro.url.pathname);

// Custom route mapping for pages with different slugs per language.
function resolveLocalizedPath(targetLang: string) {
  if (currentPath === "/azienda/" || currentPath === "/en/company/") {
    return targetLang === "en" ? "/en/company/" : "/azienda/";
  }

  return getLocaleUrlCTM(Astro.url.pathname, targetLang);
}

const languages = supportedLanguages.map((lang) => {
  const href = resolveLocalizedPath(lang.languageCode as string);

  if (href === trailingSlashChecker(Astro.url.pathname)) {
    return;
  }

  return {
    slug: href,
    ...lang,
  };
});

if (languages.length <= 1) {
  return;
}
---

<div
  class="language-switcher hs-dropdown relative inline-block [--gpu-acceleration:false] [--offset:8] [--placement:bottom-right] [--strategy:auto] lg:[--auto-close:inside]">
  <button
    type="button"
    id="language-switcher-dropdown-toggle"
    class="language-switcher-button hs-dropdown-toggle"
    aria-expanded="false"
    aria-label="Menu">
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="24"
      height="24"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
      data-icon
      class="w-4">
      <path d="m5 8 6 6"></path><path d="m4 14 6-6 2-3"></path><path
        d="M2 5h12">
      </path><path d="M7 2h1"></path><path d="m22 22-5-10-5 10"></path><path
        d="M14 18h6">
      </path>
    </svg>
    <span class="text uppercase">{currentLocale}</span>
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="24"
      height="24"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
      data-icon
      class="hs-dropdown-open:rotate-180 ml-2 h-4 w-4 transition duration-300">
      <path d="m6 9 6 6 6-6"></path>
    </svg>
  </button>
  <ul
    class="language-switcher-dropdown hs-dropdown-menu hs-dropdown-open:opacity-100 hs-dropdown-open:mt-0! hs-dropdown-open:visible z-10 mt-2 hidden w-24 min-w-32 opacity-0 transition-[opacity,margin] [--placement:right-bottom]"
    aria-labelledby="language-switcher-dropdown-toggle">
    {
      languages.map(
        (language) =>
          language && (
            <li>
              <a
                class:list={[
                  {
                    active: language.languageCode === currentLocale,
                  },
                  "capitalize",
                ]}
                href={language.slug}>
                {language.languageName}
              </a>
            </li>
          ),
      )
    }
  </ul>
</div>
