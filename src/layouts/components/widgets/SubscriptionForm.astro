---
import { useTranslations } from "@/lib/utils/i18nUtils";
import { markdownify } from "@/lib/utils/textConverter";
const t = await useTranslations(Astro.currentLocale as string);

const { formAction } = Astro.props;
---

<form
  action={formAction}
  id="mc-embedded-subscribe-form"
  method="post"
  class="relative mb-0">
  <div class="relative">
    <label for="mce-EMAIL" class="sr-only">Email</label>
    <input
      required
      type="email"
      name="EMAIL"
      id="mce-EMAIL"
      aria-required="true"
      placeholder={t("common.emailPlaceholder")}
      class="border-border-light focus:ring-primary/4 size-full rounded-lg bg-white py-4 pl-5 shadow-none outline-0 placeholder:opacity-90 focus:ring-4"
    />
    <button
      type="submit"
      name="subscribe"
      id="mc-embedded-subscribe"
      class="absolute top-1 right-1 flex h-[calc(100%-0.5rem)] w-10 items-center justify-center rounded-lg">
      <span class="sr-only">Subscribe</span>
      <svg
        class="text-2xl"
        stroke="currentColor"
        fill="currentColor"
        stroke-width="0"
        viewBox="0 0 448 512"
        height="1em"
        width="1em"
        xmlns="http://www.w3.org/2000/svg">
        <path
          d="M446.7 98.6l-67.6 318.8c-5.1 22.5-18.4 28.1-37.3 17.5l-103-75.9-49.7 47.8c-5.5 5.5-10.1 10.1-20.7 10.1l7.4-104.9 190.9-172.5c8.3-7.4-1.8-11.5-12.9-4.1L117.8 284 16.2 252.2c-22.1-6.9-22.5-22.1 4.6-32.7L418.2 66.4c18.4-6.9 34.5 4.1 28.5 32.2z">
        </path>
      </svg>
    </button>
  </div>
  <div class="form-check mt-4">
    <input
      class="form-checkbox"
      type="checkbox"
      required
      name="agree-privacy"
      id="agree-privacy"
    />
    <label for="agree-privacy" set:html={markdownify(t("subscription.term"))} />
  </div>
  <div
    id="mce-responses"
    class="clear absolute top-[105%] left-0 w-full text-sm opacity-60">
    <div
      class="message message-error"
      id="mce-error-response"
      style="display: none">
    </div>
    <div
      class="message message-success"
      id="mce-success-response"
      style="display: none">
    </div>
  </div>
  <div style="position: absolute; left: -312.5rem" aria-hidden="true">
    <input
      type="text"
      name="b_436cb8647d746fe81825f1efc_18a007239a"
      tabindex="-1"
      value=""
    />
  </div>
  <input type="hidden" name="EMAILTYPE" id="mce-EMAILTYPE-0" value="html" />
  <span class="sr-only">gats-stella</span>
</form>
<script>
  // Define the expected response structure
  interface JsonpResponse {
    result: "success" | "error";
    msg: string;
    type?: string;
    webEngagementCookieValue?: string | null;
  }

  // Main function to handle form submission
  document
    .querySelector<HTMLFormElement>("#mc-embedded-subscribe-form")
    ?.addEventListener("submit", async (event) => {
      event.preventDefault(); // Prevent default form submission behavior

      const form = event.target as HTMLFormElement;
      const formData = new FormData(form);
      const actionUrl = form.getAttribute("action"); // Get the form's action URL

      if (!actionUrl) {
        console.error("Form action URL is missing.");
        return;
      }

      // Serialize form data to a query string
      const queryString = new URLSearchParams(formData as any).toString();

      // Select response containers
      const errorContainer = document.querySelector<HTMLElement>(
        "#mce-error-response",
      );
      const successContainer = document.querySelector<HTMLElement>(
        "#mce-success-response",
      );

      if (!errorContainer || !successContainer) {
        console.error("Error or success response containers are missing.");
        return;
      }

      // Clear previous messages
      errorContainer.style.display = "none";
      successContainer.style.display = "none";

      try {
        // Create a dynamic script tag for JSONP
        const script = document.createElement("script");
        const callbackName = `jsonpCallback_${Date.now()}`;

        // Add the JSONP callback function to the global scope
        (window as any)[callbackName] = (data: JsonpResponse) => {
          if (data.result === "success") {
            successContainer.textContent =
              data.msg || "Thank you for subscribing!";
            successContainer.style.display = "block";
          } else {
            errorContainer.textContent =
              data.msg || "An error occurred. Please try again.";
            errorContainer.style.display = "block";
          }

          // Clean up after the callback is executed
          delete (window as any)[callbackName];
          script.remove();
        };

        // Append the JSONP callback and form data to the URL
        script.src = `${actionUrl}&c=${callbackName}&${queryString}`;
        script.onerror = () => {
          errorContainer.textContent =
            "There was an error processing your request. Please try again later.";
          errorContainer.style.display = "block";
          console.error("Error loading JSONP script.");
        };

        // Append the script tag to the document
        document.body.appendChild(script);
      } catch (error) {
        // Handle any unexpected errors
        errorContainer.textContent =
          "There was an error processing your request. Please try again later.";
        errorContainer.style.display = "block";
        console.error("Error:", error);
      }
    });
</script>
