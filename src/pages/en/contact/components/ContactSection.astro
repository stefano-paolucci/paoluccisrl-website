---
import ContactForm from "@/components/widgets/ContactForm.astro";
import OptimizedImage from "@/components/utilities/OptimizedImage.astro";

const TURNSTILE_SITE_KEY = import.meta.env.PUBLIC_TURNSTILE_SITE_KEY;
---

<section class="relative contact-section">
  <div class="container">
    <div class="grid grid-cols-1 gap-10 lg:grid-cols-2 lg:items-center">
      <div class="contact-left space-y-6 pt-2 max-lg:text-center lg:self-center" data-aos="fade-right-sm" data-aos-delay="100" data-aos-duration="900">
          <h2 class="font-primary text-h2-sm md:text-h2 capitalize font-extrabold">Contact</h2>
          <p class="text-lg leading-relaxed">
            For information, write to us or call the contacts below.
            You can also submit the form or start a WhatsApp chat directly.
          </p>

          <a
            href="https://wa.me/393408459509?text=Hello%2C%20I%20would%20like%20information%20about%20your%20window%20solutions."
            target="_blank"
            rel="noopener noreferrer"
            class="group max-lg:mx-auto inline-flex items-center gap-3 rounded-full border border-[#25D366]/35 bg-[#25D366]/10 px-6 py-3 font-medium text-inherit transition-all duration-300 hover:-translate-y-0.5 hover:border-[#25D366] hover:bg-[#25D366]/20">
            <span class="inline-flex h-8 w-8 items-center justify-center rounded-full text-current [&_svg_*]:fill-current [&_svg_*]:stroke-current">
              <OptimizedImage inlineSvg={true} src="/images/whatsapp-icon.svg" alt="WhatsApp" class="h-5 w-5 text-current" />
            </span>
            <span>Chat on WhatsApp</span>
          </a>

          <div class="mt-6 grid gap-6 max-lg:justify-items-center md:grid-cols-3">
            <div class="space-y-3 max-lg:text-center">
              <span class="max-lg:mx-auto inline-flex h-10 w-10 items-center justify-center rounded-xl bg-primary text-white">
                <OptimizedImage inlineSvg={true} src="/images/place-icon.svg" alt="Address" class="h-5 w-5" />
              </span>
              <div>
                <p class="font-semibold">Address</p>
                <p>Via Colle Marchitto, snc</p>
                <p>03039 Sora (FR), Italia</p>
              </div>
            </div>

            <div class="space-y-3 max-lg:text-center">
              <span class="max-lg:mx-auto inline-flex h-10 w-10 items-center justify-center rounded-xl bg-primary text-white">
                <OptimizedImage inlineSvg={true} src="/images/phone-icon.svg" alt="Phone and email" class="h-5 w-5" />
              </span>
              <div>
                <p class="font-semibold">Phone and email</p>
                <a class="block underline underline-offset-4" href="tel:+393408459509">+39 340 845 9509</a>
                <a class="block underline underline-offset-4" href="mailto:info@paoluccisrl.com">info@paoluccisrl.com</a>
              </div>
            </div>

            <div class="space-y-3 max-lg:text-center">
              <span class="max-lg:mx-auto inline-flex h-10 w-10 items-center justify-center rounded-xl bg-primary text-white">
                <OptimizedImage inlineSvg={true} src="/images/facebook-icon.svg" alt="Facebook" class="h-5 w-5" />
              </span>
              <div>
                <p class="font-semibold">Facebook</p>
                <a class="block underline underline-offset-4" target="_blank" rel="noopener noreferrer" href="https://www.facebook.com/paoluccisrl">/paoluccisrl</a>
              </div>
            </div>
          </div>
      </div>

      <div class="contact-right lg:self-center" data-aos="fade-left-sm" data-aos-delay="120" data-aos-duration="900">
        <ContactForm
          customHandler={true}
          class="!w-full !max-w-none !rounded-[0.5rem] !bg-[#f8f8f8] !p-6 md:!p-8 lg:!p-10 dark:!bg-[#262a2f]"
          form={{
            emailSubject: "New request from Paolucci SRL website",
            submitButton: { enable: true, label: "SEND MESSAGE" },
            inputs: [
              { label: "", placeholder: "Name *", name: "Name", required: true, halfWidth: true, defaultValue: "" },
              { label: "", placeholder: "Surname *", name: "Surname", required: true, halfWidth: true, defaultValue: "" },
              { label: "", placeholder: "Email *", name: "Email", required: true, type: "email", halfWidth: false, defaultValue: "" },
              { label: "", placeholder: "Phone number *", name: "Phone", required: true, halfWidth: false, defaultValue: "" },
              { label: "", tag: "textarea", defaultValue: "", rows: "4", placeholder: "Message... *", name: "Message", required: true, halfWidth: false },
              { label: "I have read and I accept the [Privacy Policy](/privacy-policy/)", id: "privacy-policy", name: "Privacy", value: "Agreed", checked: false, required: true, type: "checkbox", halfWidth: false, defaultValue: "" },
              { note: "success", parentClass: "hidden text-sm message success", content: "Request sent successfully. We will contact you shortly." },
              { note: "deprecated", parentClass: "hidden text-sm message error", content: "Submission failed. Please email us at [info@paoluccisrl.com](mailto:info@paoluccisrl.com)." }
            ],
          } as any}
        />

        <div
          id="turnstile-widget"
          class="mt-3"
          data-site-key={TURNSTILE_SITE_KEY || ""}>
        </div>
      </div>
    </div>
  </div>
</section>

{TURNSTILE_SITE_KEY ? (
  <script is:inline src="https://challenges.cloudflare.com/turnstile/v0/api.js?render=explicit" async defer></script>
) : null}

<script>
  import { setMessage } from "@/lib/utils/FormHandle";

  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("contact-form") as HTMLFormElement | null;
    if (!form) return;

    const honeypot = document.createElement("input");
    honeypot.type = "text";
    honeypot.name = "website";
    honeypot.autocomplete = "off";
    honeypot.tabIndex = -1;
    honeypot.setAttribute("aria-hidden", "true");
    honeypot.style.position = "absolute";
    honeypot.style.left = "-10000px";
    honeypot.style.top = "auto";
    honeypot.style.width = "1px";
    honeypot.style.height = "1px";
    honeypot.style.opacity = "0";
    form.appendChild(honeypot);

    const getInputByName = (name: string) =>
      (form.querySelector(`[name="${CSS.escape(name)}"]`) as HTMLInputElement | HTMLTextAreaElement | null);

    const getCheckboxValue = (name: string) => {
      const el = getInputByName(name) as HTMLInputElement | null;
      return !!el?.checked;
    };

    const normalize = (v: unknown) => String(v ?? "").trim();
    const isName = (s: string) => /^[a-zA-ZÀ-ÿ\s'-]+$/.test(s);
    const isEmail = (s: string) => /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(s);
    const isPhone = (s: string) => /^\+?[0-9\s-]+$/.test(s);
    const hasDangerousMessageChars = (s: string) => /[<>{}[\]`\\]/.test(s);

    const validate = (payload: any) => {
      const errors: string[] = [];

      if (!payload.firstName) errors.push("Name is required");
      else if (payload.firstName.length < 2) errors.push("Name: minimum 2 characters");
      else if (payload.firstName.length > 50) errors.push("Name: maximum 50 characters");
      else if (!isName(payload.firstName)) errors.push("Name: invalid characters");

      if (!payload.lastName) errors.push("Surname is required");
      else if (payload.lastName.length < 2) errors.push("Surname: minimum 2 characters");
      else if (payload.lastName.length > 50) errors.push("Surname: maximum 50 characters");
      else if (!isName(payload.lastName)) errors.push("Surname: invalid characters");

      if (!payload.email) errors.push("Email is required");
      else if (!isEmail(payload.email)) errors.push("Email is invalid");

      if (!payload.phone) errors.push("Phone is required");
      else if (payload.phone.length < 8 || payload.phone.length > 20) errors.push("Phone: invalid length");
      else if (!isPhone(payload.phone)) errors.push("Phone: only numbers, spaces, dashes and optional leading +");

      if (!payload.message) errors.push("Message is required");
      else if (payload.message.length < 10) errors.push("Message: minimum 10 characters");
      else if (payload.message.length > 1000) errors.push("Message: maximum 1000 characters");
      else if (hasDangerousMessageChars(payload.message)) errors.push("Message: forbidden characters");

      if (!payload.privacy) errors.push("Please accept the Privacy Policy");

      return errors;
    };

    const siteKey =
      (
        document.getElementById("turnstile-widget") as HTMLElement | null
      )?.dataset.siteKey || "";
    let widgetId: string | null = null;
    let lastTurnstileToken = "";

    const ensureTurnstileRendered = async () => {
      if (!siteKey) throw new Error("Missing Turnstile site key");
      if (widgetId) return widgetId;

      await new Promise<void>((resolve, reject) => {
        const start = Date.now();
        const tick = () => {
          // @ts-ignore
          if (typeof window.turnstile !== "undefined") return resolve();
          if (Date.now() - start > 8000) return reject(new Error("Turnstile not loaded"));
          requestAnimationFrame(tick);
        };
        tick();
      });

      // @ts-ignore
      widgetId = window.turnstile.render("#turnstile-widget", {
        sitekey: siteKey,
        callback: (token: string) => {
          lastTurnstileToken = token;
        },
        "error-callback": () => {
          lastTurnstileToken = "";
        },
        "expired-callback": () => {
          lastTurnstileToken = "";
        },
      });

      return widgetId!;
    };

    const getTurnstileToken = async () => {
      const id = await ensureTurnstileRendered();
      // @ts-ignore
      const token = lastTurnstileToken || window.turnstile.getResponse(id);
      if (!token) throw new Error("Turnstile token missing");
      return token;
    };

    form.addEventListener("submit", async (e: Event) => {
      e.preventDefault();

      const firstName = normalize(getInputByName("Name")?.value);
      const lastName = normalize(getInputByName("Surname")?.value);
      const email = normalize(getInputByName("Email")?.value);
      const phone = normalize(getInputByName("Phone")?.value);
      const message = normalize((getInputByName("Message") as HTMLTextAreaElement | null)?.value);
      const privacy = getCheckboxValue("Privacy");

      const payload = {
        firstName,
        lastName,
        email,
        phone,
        company: "Private customer",
        message,
        privacy,
        honeypot: normalize(honeypot.value),
      };

      const validationErrors = validate(payload);
      if (validationErrors.length > 0) {
        setMessage(validationErrors[0], false, false, form);
        return;
      }

      setMessage("Sending...", true, true, form);

      try {
        const turnstileToken = await getTurnstileToken();

        const res = await fetch("/api/contact", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ ...payload, turnstileToken }),
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok) {
          lastTurnstileToken = "";
          if (widgetId && typeof window !== "undefined" && (window as any).turnstile) {
            // @ts-ignore
            window.turnstile.reset(widgetId);
          }
          setMessage(data?.error || "Submission failed. Please try again in a moment.", false, false, form);
          return;
        }

        form.reset();
        honeypot.value = "";
        lastTurnstileToken = "";
        if (widgetId && typeof window !== "undefined" && (window as any).turnstile) {
          // @ts-ignore
          window.turnstile.reset(widgetId);
        }
        setMessage("Request sent successfully. We will contact you shortly.", true, false, form);
      } catch (err) {
        console.error("Contact submit error:", err);
        const message =
          err instanceof Error && err.message === "Turnstile token missing"
            ? "Complete the anti-spam verification and try again."
            : "Connection or anti-spam verification error. Please try again.";
        setMessage(message, false, false, form);
      }
    });
  });
</script>
